// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema
// Force cache invalidation: 2025-11-22

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  role      String   @default("PATIENT") // UserRole
  phoneNumber String? @unique // Número de teléfono (para login alternativo con OTP)
  createdAt DateTime @default(now())

  // Relaciones
  doctor            Doctor?
  patient           Patient?
  notificationToken NotificationToken[]

  @@index([email])
  @@index([phoneNumber])
  @@map("users")
}

model Doctor {
  id             String  @id @default(cuid())
  userId         String  @unique
  name           String
  rut            String? @unique
  speciality     String
  horarios       String?
  tarifaConsulta Decimal @default(0)
  tarifaUrgencia Decimal @default(0)
  estadoOnline   Boolean @default(false)

  // Configuración de disponibilidad automática
  horariosAutomaticos String? // JSON con configuración de horarios

  // Configuración de pagos
  payoutMode      String  @default("IMMEDIATE") // "IMMEDIATE" | "MONTHLY"
  payoutDay       Int     @default(5) // Día del mes para liquidación (1-28)
  bankAccountInfo String? // JSON con datos bancarios

  // Validación de identidad y profesión
  identidadValidada        Boolean   @default(false)
  profesionValidada        Boolean   @default(false)
  rnpiEstado               String?   // Estado en RNPI: "HABILITADO" | "SUSPENDIDO" | "NO_EXISTE"
  rnpiProfesion            String?   // Profesión según RNPI
  rnpiFechaVerificacion    DateTime? // Última fecha de verificación RNPI
  verificacionEstadoFinal  String    @default("PENDIENTE") // "PENDIENTE" | "VERIFICADO" | "RECHAZADO" | "REVISION_MANUAL"
  logsValidacion           String?   // JSON con logs detallados de validaciones
  identityVerificationData  String?  // JSON encriptado con datos de Registro Civil
  rnpiVerificationData      String?  // JSON encriptado con datos de RNPI
  lastVerificationAt        DateTime? // Última verificación completa
  verificationErrors        String?  // JSON con errores de validación

  // Configuración WhatsApp Business (para auto-respuesta)
  whatsappBusinessNumber String? // Número de WhatsApp Business verificado
  whatsappBusinessId      String? // ID de WhatsApp Business en Meta

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  consultations Consultation[]
  payoutBatches PayoutBatch[]
  consultationAttempts ConsultationAttempt[]

  @@index([userId])
  @@index([rut])
  @@index([verificacionEstadoFinal])
  @@index([identidadValidada])
  @@index([profesionValidada])
  @@index([whatsappBusinessNumber])
  @@map("doctors")
}

model Patient {
  id             String   @id @default(cuid())
  userId         String   @unique
  name           String
  rut            String?  // RUT del paciente (necesario para recetas SNRE)
  age            Int?
  birthDate      DateTime? // Fecha de nacimiento (necesaria para SNRE)
  gender         String?  // "male" | "female" | "other" | "unknown"
  medicalHistory String?
  address        String?  // Dirección completa o JSON
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Número de teléfono (identificador alternativo para login con OTP)
  phoneNumber String? @unique

  // Relaciones
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  consultations Consultation[]

  @@index([userId])
  @@index([rut])
  @@index([phoneNumber])
  @@map("patients")
}

model Consultation {
  id        String    @id @default(cuid())
  doctorId  String
  patientId String
  type      String    @default("NORMAL") // ConsultationType
  status    String    @default("PENDING") // ConsultationStatus
  paymentId String?   @unique
  source    String    @default("APP") // "WHATSAPP" | "APP" | "WEB" - Origen de la consulta
  consultationAttemptId String? // ID del intento de WhatsApp que originó esta consulta
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  closedAt  DateTime?

  // Relaciones
  doctor   Doctor    @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  patient  Patient   @relation(fields: [patientId], references: [id], onDelete: Cascade)
  payment  Payment?
  messages Message[]
  prescriptions Prescription[] // Recetas SNRE asociadas
  consultationAttempt ConsultationAttempt? @relation(fields: [consultationAttemptId], references: [id])

  @@index([doctorId])
  @@index([patientId])
  @@index([status])
  @@index([createdAt])
  @@index([source])
  @@index([consultationAttemptId])
  @@map("consultations")
}

model Message {
  id             String   @id @default(cuid())
  consultationId String
  senderId       String
  text           String?
  fileUrl        String?
  audioUrl       String?
  pdfUrl         String?
  createdAt      DateTime @default(now())

  // Relaciones
  consultation Consultation @relation(fields: [consultationId], references: [id], onDelete: Cascade)

  @@index([consultationId])
  @@index([createdAt])
  @@map("messages")
}

model Payment {
  id                      String    @id @default(cuid())
  amount                  Decimal
  fee                     Decimal
  netAmount               Decimal
  status                  String    @default("PENDING") // PaymentStatus
  mercadopagoPreferenceId String?   @unique
  mercadopagoPaymentId    String?   @unique
  consultationId          String?   @unique
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  paidAt                  DateTime?

  // Estado de liquidación al médico
  payoutStatus  String    @default("PENDING") // "PENDING" | "SCHEDULED" | "PAID_OUT"
  payoutDate    DateTime? // Fecha de liquidación efectiva
  payoutBatchId String? // ID del lote de liquidación

  // Relaciones
  consultation Consultation? @relation(fields: [consultationId], references: [id])

  @@index([status])
  @@index([mercadopagoPreferenceId])
  @@index([createdAt])
  @@index([payoutStatus])
  @@index([payoutBatchId])
  @@map("payments")
}

model NotificationToken {
  id          String   @id @default(cuid())
  userId      String
  deviceToken String   @unique
  platform    String? // web, ios, android
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relaciones
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([deviceToken])
  @@map("notification_tokens")
}

model PayoutBatch {
  id           String    @id @default(cuid())
  doctorId     String
  period       String // "2024-11" formato año-mes
  totalAmount  Decimal // Suma de netAmount de todos los pagos
  paymentCount Int // Cantidad de pagos incluidos
  status       String    @default("PENDING") // "PENDING" | "PROCESSED" | "PAID"
  processedAt  DateTime?
  createdAt    DateTime  @default(now())

  // Relaciones
  doctor Doctor @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@index([doctorId])
  @@index([period])
  @@index([status])
  @@map("payout_batches")
}

model DoctorSignupRequest {
  id                 String    @id @default(cuid())
  name               String
  rut                String?
  birthDate          DateTime? // Fecha de nacimiento para validación
  specialty          String
  registrationNumber String?
  email              String
  phone              String?
  clinicOrCenter     String?
  notes              String?
  status             String    @default("PENDING") // "PENDING" | "REVIEWED" | "APPROVED" | "REJECTED" | "AUTO_APPROVED" | "AUTO_REJECTED"
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  reviewedAt         DateTime?
  reviewedBy         String? // ID del admin que revisó

  // Validaciones automáticas
  identityVerificationStatus String? // "IDENTIDAD_VERIFICADA" | "IDENTIDAD_NO_COINCIDE" | "RUN_INVALIDO" | "PENDING"
  identityVerificationResult String? // JSON con detalles de validación de identidad
  identityVerifiedAt         DateTime?
  
  rnpiVerificationStatus     String? // "MEDICO_VERIFICADO" | "NO_MEDICO" | "SUSPENDIDO" | "INCONSISTENCIA" | "PENDING"
  rnpiVerificationResult     String? // JSON con datos oficiales de RNPI
  rnpiVerifiedAt             DateTime?
  
  autoVerificationErrors     String? // JSON con errores de validación automática

  @@index([status])
  @@index([email])
  @@index([rut])
  @@index([createdAt])
  @@index([identityVerificationStatus])
  @@index([rnpiVerificationStatus])
  @@map("doctor_signup_requests")
}

// Modelo para recetas electrónicas SNRE
model Prescription {
  id                String   @id @default(cuid())
  consultationId    String
  doctorId          String
  patientId         String
  
  // Estado de la receta en SNRE
  status            String   @default("PENDIENTE_ENVIO_SNRE") // "PENDIENTE_ENVIO_SNRE" | "ENVIADA_SNRE" | "ERROR_SNRE" | "ANULADA_SNRE"
  
  // Identificadores SNRE
  snreId            String?  @unique // ID de la receta en el SNRE
  snreCode          String?  // Código único de la receta para el paciente (si lo provee SNRE)
  snreBundleId      String?  // ID del Bundle FHIR en SNRE
  
  // Datos FHIR enviados (para auditoría)
  fhirBundle        String?  // JSON del Bundle FHIR enviado
  
  // Errores
  errorMessage      String?  // Mensaje de error si falla
  errorDetails      String?  // Detalles técnicos del error (JSON)
  
  // Metadata
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  sentToSnreAt      DateTime? // Fecha de envío exitoso a SNRE
  
  // Relaciones
  consultation      Consultation @relation(fields: [consultationId], references: [id], onDelete: Cascade)
  prescriptionItems PrescriptionItem[] // Medicamentos de la receta

  @@index([consultationId])
  @@index([doctorId])
  @@index([patientId])
  @@index([status])
  @@index([snreId])
  @@index([createdAt])
  @@map("prescriptions")
}

// Modelo para items de medicamentos en una receta
model PrescriptionItem {
  id             String   @id @default(cuid())
  prescriptionId String
  
  // Datos del medicamento
  medicationName String   // Nombre del medicamento
  tfcCode        String?  // Código TFC (Terminología Farmacéutica Chilena)
  snomedCode     String?  // Código SNOMED-CT si aplica
  presentation   String?  // Presentación (ej: "Tabletas 500mg")
  pharmaceuticalForm String? // Forma farmacéutica
  
  // Posología
  dosage         String   // Dosis (ej: "1 tableta")
  frequency      String   // Frecuencia (ej: "cada 8 horas")
  duration       String?  // Duración (ej: "7 días")
  quantity       String?  // Cantidad total a dispensar
  
  // Indicaciones
  instructions   String?  // Instrucciones adicionales al paciente
  
  // Orden en la receta
  order          Int      @default(0) // Orden del medicamento en la receta
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  // Relaciones
  prescription   Prescription @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)

  @@index([prescriptionId])
  @@index([tfcCode])
  @@map("prescription_items")
}

// Modelo para intentos de consulta desde WhatsApp (antes de convertirse en consulta pagada)
model ConsultationAttempt {
  id                String   @id @default(cuid())
  doctorId          String
  patientPhone      String   // Número de teléfono del paciente
  source            String   @default("WHATSAPP") // "WHATSAPP" | "SMS" | "EMAIL"
  status            String   @default("PENDING") // "PENDING" | "CONVERTED" | "ABANDONED"
  messageText       String?  // Texto original del mensaje de WhatsApp
  consultationId    String?  @unique // Si se convierte, ID de la consulta creada
  deepLinkSent      Boolean  @default(false) // Si se envió el deep link
  deepLinkClicked   Boolean  @default(false) // Si el paciente hizo clic en el link
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  convertedAt       DateTime? // Fecha en que se convirtió en consulta pagada
  
  // Relaciones
  doctor            Doctor   @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  consultation      Consultation? @relation(fields: [consultationId], references: [id])
  
  @@index([doctorId])
  @@index([patientPhone])
  @@index([status])
  @@index([createdAt])
  @@map("consultation_attempts")
}

// Modelo para verificación OTP (One-Time Password) por WhatsApp/SMS
model OTPVerification {
  id          String   @id @default(cuid())
  phoneNumber String   // Número de teléfono al que se envió el OTP
  otp         String   // Hash del OTP (no texto plano, usar bcrypt)
  method      String   @default("WHATSAPP") // "WHATSAPP" | "SMS"
  verified    Boolean  @default(false) // Si el OTP fue verificado
  expiresAt   DateTime // Fecha de expiración del OTP (típicamente 5 minutos)
  createdAt   DateTime @default(now())
  
  @@index([phoneNumber])
  @@index([expiresAt])
  @@map("otp_verifications")
}
